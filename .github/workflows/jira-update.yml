- name: Sync PR updates with Jira (Direct API using Bearer token)
  env:
    JIRA_TOKEN: ${{ secrets.JIRA_TOKEN }}
    JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
  run: |
    if [ -z "${{ env.JIRA_ID }}" ]; then
      echo "No Jira ID found, skipping Jira update."
      exit 0
    fi

    if [ "${{ github.event_name }}" = "issue_comment" ] || [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
      COMMENT_BODY="${{ github.event.comment.body }}"
    else
      STATUS=${{ github.event.action }}
      COMMENT_BODY="GitHub PR #${{ github.event.number }} is $STATUS."
    fi

    echo "Original comment:"
    echo "$COMMENT_BODY"

    ESCAPED_COMMENT_BODY=$(jq -R --arg str "$COMMENT_BODY" '$str' <<<"$COMMENT_BODY")

    echo "Posting escaped comment to Jira:"
    echo "$ESCAPED_COMMENT_BODY"

    curl -X POST "${JIRA_BASE_URL}/rest/api/2/issue/${{ env.JIRA_ID }}/comment" \
      -H "Authorization: Bearer $JIRA_TOKEN" \
      -H "Content-Type: application/json" \
      -d "{\"body\":$ESCAPED_COMMENT_BODY}"
